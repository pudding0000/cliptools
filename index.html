<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‰ªè²¼ç°¿å·¥å…· + æª”æ¡ˆä¸Šå‚³ + QR</title>
  <style>
    body { background: #f3f6fb; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    h1 { color: #333; }
    #clipboard {
      width: 80%; height: 200px; margin: 20px auto; padding: 10px;
      border: 2px solid #ccc; border-radius: 10px; background: white;
      font-size:18px; resize:none;
    }
    input, #status { margin-top:10px; }
    #mobile-qr {
      margin: 20px auto; text-align: center;
    }
    #mobile-qr img {
      max-width: 200px; border:2px solid #ccc; border-radius:8px;
    }
    #history { max-width:80%; margin:30px auto; text-align:left; list-style:none; padding:0; }
    .item {
      position:relative; background:#fff; padding:10px; margin:8px 0;
      border:1px solid #ddd; border-radius:6px;
    }
    .delete-btn {
      position:absolute; top:6px; right:6px; border:none; background:none;
      color:red; cursor:pointer; font-size:16px;
    }
  </style>
</head>
<body>
  <h1>å‰ªè²¼ç°¿å·¥å…·</h1>

  <textarea id="clipboard" placeholder="Shift+Enter æ›è¡Œï¼ŒEnter åŒæ­¥ä¸¦åŠ å…¥æ­·å²"></textarea><br>

  <div id="mobile-qr">
    <p>æ‰‹æ©Ÿé–‹å•Ÿç¶²å€</p>
    <img src="assets/images/qrcode.png" alt="QR Code ç¶²å€" />
  </div>

  <input type="file" id="upload" />
  <div id="status"></div>

  <ul id="history"></ul>

  <!-- è¼‰å…¥ Supabase & Firebase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // â­ Supabase åˆå§‹åŒ–
    const supabase = supabase.createClient(
      'https://iudrrkimbkpztjcqzgfx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZHJya2ltYmtwenRqY3F6Z2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTQzNzgsImV4cCI6MjA2NjMzMDM3OH0.0zHo3IlsxiF9_HfNJFFdhenjRnerKResdL96IAa6XHE'
    );

    // ğŸ” Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCX_CxCX...ä½ çš„APIKey",
      authDomain: "cliptools2.firebaseapp.com",
      databaseURL: "https://cliptools2-default-rtdb.firebaseio.com",
      projectId: "cliptools2",
      storageBucket: "cliptools2.firebasestorage.app",
      messagingSenderId: "719870992662",
      appId: "1:719870992662:web:2c2c413f2bc95effceb037"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const clipRef = db.ref("clipboard");
    const textsRef = db.ref("clipboard/texts");

    // DOM å…ƒä»¶
    const textarea = document.getElementById("clipboard");
    const upload = document.getElementById("upload");
    const status = document.getElementById("status");
    const historyList = document.getElementById("history");
    let itemCount = 0;

    function addHistoryItem(key, text) {
      itemCount++;
      const li = document.createElement("li");
      li.className = "item";
      li.dataset.key = key;
      li.innerHTML = `<strong>${itemCount}.</strong> ${text}
                      <button class="delete-btn">âœ–</button>`;
      li.querySelector(".delete-btn").onclick = () => {
        textsRef.child(key).remove();
        li.remove();
        itemCount = 0;
        Array.from(historyList.children).forEach((el, idx) => {
          el.querySelector("strong").textContent = `${++itemCount}.`;
        });
      };
      historyList.appendChild(li);
    }

    // æ–‡å­—åŒæ­¥åŠæ­·å²ç´€éŒ„
    textarea.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const val = textarea.value;
        clipRef.update({ content: val });
        textsRef.push(val);
      }
    });
    textarea.addEventListener("input", () => {
      clipRef.update({ content: textarea.value });
    });
    clipRef.on("value", snap => {
      const v = snap.val()?.content;
      if (v !== undefined && document.activeElement !== textarea) {
        textarea.value = v;
      }
    });
    textsRef.on("child_added", snap => {
      addHistoryItem(snap.key, snap.val());
    });

    // æª”æ¡ˆä¸Šå‚³åˆ° Supabase Storage
    upload.addEventListener("change", async () => {
      const file = upload.files[0];
      if (!file) return;
      status.textContent = "ä¸Šå‚³ä¸­...";
      const filename = `${Date.now()}_${file.name}`;
      const { data, error } = await supabase
        .storage
        .from('cliptoolsupload')
        .upload(filename, file);
      if (error) {
        console.error(error);
        status.textContent = "ä¸Šå‚³å¤±æ•— âŒ";
        return;
      }
      const { publicUrl, error: urlErr } = supabase
        .storage
        .from('cliptoolsupload')
        .getPublicUrl(filename);
      if (urlErr) {
        console.error(urlErr);
        status.textContent = "å–å¾—é€£çµå¤±æ•— âŒ";
        return;
      }
      const val = `å·²ä¸Šå‚³ï¼š${publicUrl}`;
      clipRef.update({ content: val });
      textsRef.push(val);
      status.textContent = "ä¸Šå‚³æˆåŠŸ âœ…";
    });
  </script>
</body>
</html>
