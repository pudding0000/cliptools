<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <title>å‰ªè²¼ç°¿å·¥å…·</title>
  <style>
    body { background: #f3f6fb; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    h1 { color: #333; }
    #clipboard {
      width: 80%; height: 200px; margin: 20px auto;
      padding: 10px; border: 2px solid #ccc;
      border-radius: 10px; background: white;
      font-size: 18px; resize: none;
    }
    #upload { margin-top: 10px; }
    #status { margin-top: 5px; }
    #mobile-qr {
      margin: 30px auto; text-align: center;
    }
    #mobile-qr img {
      max-width: 200px; height: auto;
      border: 2px solid #ccc; border-radius: 8px;
    }
    #history { margin: 30px auto; text-align: left; max-width: 80%; padding: 0; list-style: none; }
    .item {
      position: relative; background: white; margin: 8px 0;
      padding: 10px; border-radius: 6px; border: 1px solid #ddd;
      font-size: 16px;
    }
    .item-number { font-weight: bold; margin-right: 8px; }
    .delete-btn {
      position: absolute; top: 6px; right: 6px; cursor: pointer;
      color: red; border: none; background: transparent; font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>å‰ªè²¼ç°¿å·¥å…·</h1>

  <textarea id="clipboard" placeholder="Shift+Enter æ›è¡Œï¼ŒEnter åŒæ­¥ä¸¦åŠ å…¥æ­·å²"></textarea><br>
  <input type="file" id="upload"/><div id="status"></div>

  <!-- QR Code éœæ…‹å±•ç¤ºå€ -->
  <div id="mobile-qr">
    <p>æ‰‹æ©Ÿé–‹å•Ÿç¶²å€</p>
    <img src="assets/images/qrcode.png" alt="QR Code ç¶²å€">
  </div>

  <ul id="history"></ul>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // ğŸ”‘ ä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCX_CxCX4qzdppocOx8INI1nmcrM15buDI",
      authDomain: "cliptools2.firebaseapp.com",
      databaseURL: "https://cliptools2-default-rtdb.firebaseio.com",
      projectId: "cliptools2",
      storageBucket: "cliptools2.firebasestorage.app",
      messagingSenderId: "719870992662",
      appId: "1:719870992662:web:2c2c413f2bc95effceb037"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const clipRef = db.ref("clipboard");
    const textsRef = db.ref("clipboard/texts");
    const textarea = document.getElementById("clipboard");
    const upload = document.getElementById("upload");
    const status = document.getElementById("status");
    const historyList = document.getElementById("history");
    let itemCount = 0;

    function addHistoryItem(key, text) {
      itemCount++;
      const li = document.createElement("li");
      li.className = "item";
      li.dataset.key = key;

      const no = document.createElement("span");
      no.className = "item-number";
      no.textContent = itemCount + ".";

      const content = document.createElement("span");
      content.textContent = text;

      const btn = document.createElement("button");
      btn.className = "delete-btn";
      btn.textContent = "âœ–";
      btn.onclick = () => {
        textsRef.child(key).remove();
        li.remove();
        itemCount = 0;
        Array.from(historyList.children).forEach((el, idx) => {
          el.querySelector(".item-number").textContent = (idx + 1) + ".";
          itemCount++;
        });
      };

      li.append(no, content, btn);
      historyList.appendChild(li);
    }

    // ğŸ”„ Enter åŒæ­¥æ–‡å­—ä¸¦åŠ å…¥æ­·å²
    textarea.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const val = textarea.value;
        clipRef.update({ content: val });
        textsRef.push(val);
      }
    });

    // ä»»ä½•è¼¸å…¥ä¹ŸåŒæ­¥ textarea contentï¼Œä½†ä¸æ–°å¢æ­·å²
    textarea.addEventListener('input', () => {
      clipRef.update({ content: textarea.value });
    });

    // æ¥æ”¶åŒæ­¥æ–‡å­—æ›´æ–° textarea
    clipRef.on('value', snap => {
      const v = snap.val()?.content;
      if (v !== undefined && document.activeElement !== textarea) {
        textarea.value = v;
      }
    });

    // æ¥æ”¶æ–‡å­—æ­·å²ä¸¦é¡¯ç¤ºé …ç›®
    textsRef.on('child_added', snap => {
      addHistoryItem(snap.key, snap.val());
    });

    // æª”æ¡ˆä¸Šå‚³è™•ç†
    upload.addEventListener('change', async () => {
      const file = upload.files[0];
      if (!file) return;
      status.textContent = "ä¸Šå‚³ä¸­...";
      const fd = new FormData();
      fd.append("file", file);
      try {
        const res = await fetch("https://file.io", { method: "POST", body: fd });
        const json = await res.json();
        if (json.success) {
          status.textContent = "ä¸Šå‚³æˆåŠŸ âœ…";
          const val = `å·²ä¸Šå‚³ï¼š${json.link}`;
          clipRef.update({ content: val });
          textsRef.push(val);
        } else {
          status.textContent = "ä¸Šå‚³å¤±æ•— âŒ";
        }
      } catch (err) {
        console.error(err);
        status.textContent = "ä¸Šå‚³å¤±æ•— âŒ";
      }
    });
  </script>
</body>
</html>
